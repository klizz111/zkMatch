<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæ€åŠ å¯†åŒ¹é…ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fhe.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”’ åŒæ€åŠ å¯†åŒ¹é…ç³»ç»Ÿ</h1>
            <p>åŸºäºElGamalåŒæ€åŠ å¯†çš„éšç§ä¿æŠ¤åŒ¹é…å¹³å°</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('init')">ç³»ç»Ÿåˆå§‹åŒ–</button>
            <button class="nav-tab" onclick="switchTab('send')">å‘é€åŒ¹é…è¯·æ±‚</button>
            <button class="nav-tab" onclick="switchTab('requests')">å¤„ç†è¯·æ±‚</button>
            <button class="nav-tab" onclick="switchTab('results')">åŒ¹é…ç»“æœ</button>
        </div>

        <!-- ç³»ç»Ÿåˆå§‹åŒ–æ ‡ç­¾é¡µ -->
        <div id="init" class="tab-content active">
            <div class="security-info">
                <h4>ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§</h4>
                <ul>
                    <li>ä½¿ç”¨ElGamalåŒæ€åŠ å¯†ä¿æŠ¤ç”¨æˆ·é€‰æ‹©</li>
                    <li>Diffie-Hellmanå¯†é’¥äº¤æ¢ç¡®ä¿é€šä¿¡å®‰å…¨</li>
                    <li>è”ç³»æ–¹å¼ä¸åŒ¹é…ç»“æœåŒæ€ç»‘å®š</li>
                    <li>å¹³å°æ— æ³•è·çŸ¥ç”¨æˆ·çœŸå®é€‰æ‹©å’Œè”ç³»æ–¹å¼</li>
                    <li>åªæœ‰åŒæ–¹éƒ½åŒæ„æ—¶æ‰èƒ½è·å¾—å¯¹æ–¹è”ç³»æ–¹å¼</li>
                </ul>
            </div>

            <div class="card">
                <h3>ğŸ“ åˆå§‹åŒ–ç”¨æˆ·åŠ å¯†å‚æ•°</h3>
                <p class="mb-3">è®¾ç½®æ‚¨çš„è”ç³»æ–¹å¼å¹¶ç”ŸæˆåŠ å¯†å¯†é’¥å¯¹</p>
                
                <div class="form-group">
                    <label for="contactInfo">è”ç³»æ–¹å¼ (é‚®ç®±/ç”µè¯/å¾®ä¿¡ç­‰)</label>
                    <input type="text" id="contactInfo" class="form-control" 
                           placeholder="ä¾‹å¦‚: alice@example.com æˆ– å¾®ä¿¡å·: alice123">
                </div>
                
                <button class="btn btn-primary" onclick="initUser()">ğŸ”‘ åˆå§‹åŒ–åŠ å¯†ç³»ç»Ÿ</button>
                
                <div id="initResult"></div>
            </div>
        </div>

        <!-- å‘é€åŒ¹é…è¯·æ±‚æ ‡ç­¾é¡µ -->
        <div id="send" class="tab-content">
            <div class="card">
                <h3>ğŸ’• å‘é€åŒ¹é…è¯·æ±‚</h3>
                <p class="mb-3">å‘å…¶ä»–ç”¨æˆ·å‘é€åŠ å¯†çš„åŒ¹é…è¯·æ±‚</p>
                
                <div class="form-group user-search">
                    <label for="targetUser">ç›®æ ‡ç”¨æˆ·</label>
                    <input type="text" id="targetUser" class="form-control" 
                           placeholder="è¾“å…¥ç”¨æˆ·åè¿›è¡Œæœç´¢..." oninput="searchUsers(this.value)">
                    <div id="searchResults" class="search-results" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label>æ‚¨çš„é€‰æ‹©</label>
                    <div>
                        <label style="font-weight: normal; margin-right: 20px;">
                            <input type="radio" name="choice" value="true" checked> 
                            âœ… æ¥å—åŒ¹é…
                        </label>
                        <label style="font-weight: normal;">
                            <input type="radio" name="choice" value="false"> 
                            âŒ æ‹’ç»åŒ¹é…
                        </label>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        æ³¨æ„ï¼šæ‚¨çš„é€‰æ‹©å°†è¢«åŠ å¯†ï¼Œå¹³å°æ— æ³•å¾—çŸ¥
                    </small>
                </div>
                
                <button class="btn btn-primary" onclick="sendMatchRequest()">ğŸš€ å‘é€åŠ å¯†åŒ¹é…è¯·æ±‚</button>
                
                <div id="sendResult"></div>
            </div>
        </div>

        <!-- å¤„ç†è¯·æ±‚æ ‡ç­¾é¡µ -->
        <div id="requests" class="tab-content">
            <div class="card">
                <h3>ğŸ“¬ å¾…å¤„ç†çš„åŒ¹é…è¯·æ±‚</h3>
                <p class="mb-3">æŸ¥çœ‹å¹¶å“åº”å…¶ä»–ç”¨æˆ·çš„åŒ¹é…è¯·æ±‚</p>
                
                <button class="btn btn-secondary" onclick="loadMatchRequests()">ğŸ”„ åˆ·æ–°è¯·æ±‚åˆ—è¡¨</button>
                
                <div id="requestsList"></div>
            </div>
        </div>

        <!-- åŒ¹é…ç»“æœæ ‡ç­¾é¡µ -->
        <div id="results" class="tab-content">
            <div class="card">
                <h3>ğŸ¯ åŒ¹é…ç»“æœ</h3>
                <p class="mb-3">æŸ¥çœ‹å¹¶è§£å¯†æ‚¨çš„åŒ¹é…ç»“æœ</p>
                
                <button class="btn btn-secondary" onclick="loadMatchResults()">ğŸ”„ åˆ·æ–°ç»“æœåˆ—è¡¨</button>
                
                <div id="resultsList"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let availableUsers = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            getCurrentUser();
            loadAvailableUsers();
        });

        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        async function getCurrentUser() {
            try {
                const response = await fetch('/api/auth/profile');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½å¯ç”¨ç”¨æˆ·åˆ—è¡¨
        async function loadAvailableUsers() {
            try {
                const response = await fetch('/api/matching/users');
                if (response.ok) {
                    const data = await response.json();
                    availableUsers = data.users || [];
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            if (tabName === 'requests') {
                loadMatchRequests();
            } else if (tabName === 'results') {
                loadMatchResults();
            }
        }

        // ç”¨æˆ·æœç´¢
        function searchUsers(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const filtered = availableUsers.filter(user => 
                user.username.toLowerCase().includes(query.toLowerCase()) ||
                (user.nickname && user.nickname.toLowerCase().includes(query.toLowerCase()))
            );

            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map(user => `
                    <div class="search-result-item" onclick="selectUser('${user.username}')">
                        <strong>${user.username}</strong>
                        ${user.nickname ? `(${user.nickname})` : ''}
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        // é€‰æ‹©ç”¨æˆ·
        function selectUser(username) {
            document.getElementById('targetUser').value = username;
            document.getElementById('searchResults').style.display = 'none';
        }

        // åˆå§‹åŒ–ç”¨æˆ·
        async function initUser() {
            const contactInfo = document.getElementById('contactInfo').value.trim();
            
            if (!contactInfo) {
                showResult('initResult', 'è¯·è¾“å…¥è”ç³»æ–¹å¼', 'error');
                return;
            }

            try {
                showResult('initResult', 'æ­£åœ¨åˆå§‹åŒ–åŠ å¯†ç³»ç»Ÿ...', 'info');
                
                const response = await fetch('/api/fhe/init_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contact_info: contactInfo
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('initResult', `
                        <div class="alert-success">
                            âœ… åˆå§‹åŒ–æˆåŠŸï¼<br>
                            ğŸ“§ è”ç³»æ–¹å¼å·²è®¾ç½®: ${contactInfo}<br>
                            ğŸ”‘ å…¬é’¥: ${data.public_key.substring(0, 20)}...<br>
                            ğŸ”’ æ‚¨çš„åŠ å¯†å‚æ•°å·²ç”Ÿæˆï¼Œå¯ä»¥å¼€å§‹åŒ¹é…äº†ï¼
                        </div>
                    `, 'success');
                } else {
                    showResult('initResult', data.message, 'error');
                }
            } catch (error) {
                showResult('initResult', 'åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å‘é€åŒ¹é…è¯·æ±‚
        async function sendMatchRequest() {
            const targetUser = document.getElementById('targetUser').value.trim();
            const choice = document.querySelector('input[name="choice"]:checked').value === 'true';
            
            if (!targetUser) {
                showResult('sendResult', 'è¯·é€‰æ‹©ç›®æ ‡ç”¨æˆ·', 'error');
                return;
            }

            try {
                showResult('sendResult', 'æ­£åœ¨å‘é€åŠ å¯†åŒ¹é…è¯·æ±‚...', 'info');
                
                const response = await fetch('/api/fhe/send_match_request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_username: targetUser,
                        choice: choice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('sendResult', `
                        <div class="alert-success">
                            âœ… åŒ¹é…è¯·æ±‚å‘é€æˆåŠŸï¼<br>
                            ğŸ¯ ç›®æ ‡ç”¨æˆ·: ${targetUser}<br>
                            ğŸ”’ æ‚¨çš„é€‰æ‹©å·²åŠ å¯†å‘é€<br>
                            ğŸ“ è¯·æ±‚ID: ${data.request_id}<br>
                            â° ç­‰å¾…å¯¹æ–¹å“åº”...
                        </div>
                    `, 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('targetUser').value = '';
                } else {
                    showResult('sendResult', data.message, 'error');
                }
            } catch (error) {
                showResult('sendResult', 'å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½åŒ¹é…è¯·æ±‚
        async function loadMatchRequests() {
            try {
                const response = await fetch('/api/fhe/get_match_requests');
                const data = await response.json();
                
                if (data.success) {
                    const requestsList = document.getElementById('requestsList');
                    
                    if (data.requests.length === 0) {
                        requestsList.innerHTML = '<p class="text-center">æš‚æ— å¾…å¤„ç†çš„åŒ¹é…è¯·æ±‚</p>';
                        return;
                    }

                    requestsList.innerHTML = data.requests.map(req => `
                        <div class="request-item">
                            <h4>ğŸ’Œ æ¥è‡ª ${req.requester_name} (${req.requester_id}) çš„åŒ¹é…è¯·æ±‚</h4>
                            <p>ğŸ“… æ—¶é—´: ${new Date(req.created_at).toLocaleString()}</p>
                            <p>ğŸ”’ å¯¹æ–¹çš„é€‰æ‹©å·²åŠ å¯†ï¼Œæ‚¨éœ€è¦åšå‡ºå›åº”æ¥å®ŒæˆåŒ¹é…è®¡ç®—</p>
                            
                            <div style="margin-top: 15px;">
                                <label style="font-weight: normal; margin-right: 20px;">
                                    <input type="radio" name="response_${req.request_id}" value="true" checked> 
                                    âœ… æ¥å—åŒ¹é…
                                </label>
                                <label style="font-weight: normal;">
                                    <input type="radio" name="response_${req.request_id}" value="false"> 
                                    âŒ æ‹’ç»åŒ¹é…
                                </label>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="respondToRequest(${req.request_id}, true)">
                                    âœ… æ¥å—å¹¶å¤„ç†
                                </button>
                                <button class="btn btn-danger" onclick="respondToRequest(${req.request_id}, false)">
                                    âŒ æ‹’ç»å¹¶å¤„ç†
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('requestsList').innerHTML = 
                        `<p class="alert-error">åŠ è½½å¤±è´¥: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('requestsList').innerHTML = 
                    `<p class="alert-error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // å“åº”åŒ¹é…è¯·æ±‚
        async function respondToRequest(requestId, choice) {
            try {
                const response = await fetch('/api/fhe/respond_match_request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        choice: choice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… å¤„ç†æˆåŠŸï¼\nåŒ¹é…ç»“æœID: ${data.match_result_id}\nè¯·åˆ°"åŒ¹é…ç»“æœ"é¡µé¢æŸ¥çœ‹å’Œè§£å¯†ç»“æœ`);
                    loadMatchRequests(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('âŒ å¤„ç†å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('âŒ å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½åŒ¹é…ç»“æœ
        async function loadMatchResults() {
            try {
                const response = await fetch('/api/fhe/get_match_results');
                const data = await response.json();
                
                if (data.success) {
                    const resultsList = document.getElementById('resultsList');
                    
                    if (data.results.length === 0) {
                        resultsList.innerHTML = '<p class="text-center">æš‚æ— åŒ¹é…ç»“æœ</p>';
                        return;
                    }

                    resultsList.innerHTML = data.results.map(result => `
                        <div class="result-item">
                            <h4>ğŸ¯ ä¸ ${result.other_name} (${result.other_user}) çš„åŒ¹é…</h4>
                            <p>ğŸ“… æ—¶é—´: ${new Date(result.created_at).toLocaleString()}</p>
                            <p>ğŸ”’ åŒ¹é…ç»“æœå·²åŠ å¯†ï¼Œç‚¹å‡»è§£å¯†æŸ¥çœ‹ç»“æœ</p>
                            
                            <button class="btn btn-primary" onclick="decryptResult(${result.match_result_id})">
                                ğŸ”“ è§£å¯†åŒ¹é…ç»“æœ
                            </button>
                            
                            <div id="result_${result.match_result_id}"></div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('resultsList').innerHTML = 
                        `<p class="alert-error">åŠ è½½å¤±è´¥: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('resultsList').innerHTML = 
                    `<p class="alert-error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // è§£å¯†åŒ¹é…ç»“æœ
        async function decryptResult(matchResultId) {
            try {
                const resultDiv = document.getElementById(`result_${matchResultId}`);
                resultDiv.innerHTML = '<p class="loading">ğŸ”“ æ­£åœ¨è§£å¯†åŒ¹é…ç»“æœ...</p>';
                
                const response = await fetch('/api/fhe/decrypt_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        match_result_id: matchResultId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.is_match && data.contact_info) {
                        resultDiv.innerHTML = `
                            <div class="alert-success" style="margin-top: 15px;">
                                ğŸ‰ åŒ¹é…æˆåŠŸï¼åŒæ–¹éƒ½åŒæ„äº†åŒ¹é…<br>
                                ğŸ“ å¯¹æ–¹è”ç³»æ–¹å¼: 
                                <div class="contact-display">${data.contact_info}</div>
                                ğŸ’¡ æ‚¨ç°åœ¨å¯ä»¥è”ç³»å¯¹æ–¹äº†ï¼
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert-info" style="margin-top: 15px;">
                                ğŸ˜” åŒ¹é…å¤±è´¥<br>
                                ${data.message}<br>
                                ğŸ”’ åŸºäºéšç§ä¿æŠ¤ï¼Œæ— æ³•è·å¾—å¯¹æ–¹è”ç³»æ–¹å¼
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-error" style="margin-top: 15px;">
                            âŒ è§£å¯†å¤±è´¥: ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById(`result_${matchResultId}`).innerHTML = `
                    <div class="alert-error" style="margin-top: 15px;">
                        âŒ è§£å¯†å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºç»“æœæ¶ˆæ¯
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-error' : 'alert-info';
            
            element.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æœç´¢ç»“æœ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-search')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });
    </script>
</body>
</html>