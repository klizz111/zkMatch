<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElGamal 加密算法测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }
        
        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #005a87;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        
        .error {
            background-color: #ffe8e8;
            color: #d00;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .success {
            background-color: #e8f5e8;
            color: #080;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .loading {
            color: #007cba;
            font-style: italic;
        }
        
        .key-display {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ElGamal 加密算法测试系统</h1>
        
        <!-- 密钥生成部分 -->
        <div class="section">
            <h2>1. 密钥生成</h2>
            <div class="form-group">
                <label for="keyBits">密钥位数:</label>
                <input type="number" id="keyBits" value="256" min="64" max="2048" step="64">
                <small>注意：位数越大，生成时间越长</small>
            </div>
            <button onclick="generateKeys()">生成密钥对</button>
            <button onclick="clearKeys()">清空密钥</button>
            
            <div id="keyResult"></div>
            <div id="keyStats"></div>
        </div>
        
        <!-- 加密部分 -->
        <div class="section">
            <h2>2. 加密测试</h2>
            <div class="form-group">
                <label for="plaintext">明文消息 (数字):</label>
                <input type="text" id="plaintext" placeholder="输入要加密的数字">
            </div>
            <button onclick="generateRandomMessage()">生成随机消息</button>
            <button onclick="encryptMessage()">加密消息</button>
            
            <div id="encryptResult"></div>
        </div>
        
        <!-- 解密部分 -->
        <div class="section">
            <h2>3. 解密测试</h2>
            <div class="form-group">
                <label for="c1Input">密文 c1:</label>
                <textarea id="c1Input" placeholder="输入密文 c1"></textarea>
            </div>
            <div class="form-group">
                <label for="c2Input">密文 c2:</label>
                <textarea id="c2Input" placeholder="输入密文 c2"></textarea>
            </div>
            <button onclick="decryptMessage()">解密消息</button>
            
            <div id="decryptResult"></div>
        </div>
        
        <!-- 完整测试部分 -->
        <div class="section">
            <h2>4. 完整加密解密测试</h2>
            <div class="form-group">
                <label for="testMessage">测试消息:</label>
                <input type="text" id="testMessage" placeholder="输入测试消息数字">
            </div>
            <button onclick="fullTest()">完整测试</button>
            <button onclick="batchTest()">批量测试</button>
            
            <div id="fullTestResult"></div>
        </div>
        
        <!-- 性能测试部分 -->
        <div class="section">
            <h2>5. 性能测试</h2>
            <div class="form-group">
                <label for="perfTestCount">测试次数:</label>
                <input type="number" id="perfTestCount" value="10" min="1" max="100">
            </div>
            <button onclick="performanceTest()">开始性能测试</button>
            
            <div id="perfResult"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/elgamal.js') }}"></script>
    <script>
        let elgamal = null;
        
        // 生成密钥对
        async function generateKeys() {
            const bits = parseInt(document.getElementById('keyBits').value);
            const resultDiv = document.getElementById('keyResult');
            const statsDiv = document.getElementById('keyStats');
            
            resultDiv.innerHTML = '<div class="loading">正在生成 ' + bits + ' 位密钥对，请稍等...</div>';
            statsDiv.innerHTML = '';
            
            try {
                const startTime = performance.now();
                
                elgamal = new ElGamal(bits);
                await new Promise(resolve => {
                    setTimeout(() => {
                        elgamal.keygen();
                        resolve();
                    }, 10);
                });
                
                const endTime = performance.now();
                const generationTime = (endTime - startTime).toFixed(2);
                
                const { p, g, y } = elgamal.getPKG();
                
                resultDiv.innerHTML = `
                    <div class="success">密钥生成成功！生成时间: ${generationTime}ms</div>
                    <div class="key-display">
                        <strong>素数 p:</strong><br>${p.toString()}<br><br>
                        <strong>生成元 g:</strong><br>${g.toString()}<br><br>
                        <strong>公钥 y:</strong><br>${y.toString()}<br><br>
                        <strong>私钥 x:</strong><br>${elgamal.x ? elgamal.x.toString() : 'Hidden'}<br><br>
                        <strong>q (p-1)/2:</strong><br>${elgamal.q.toString()}
                    </div>
                `;
                
                statsDiv.innerHTML = `
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-label">密钥位数</div>
                            <div class="stat-value">${bits}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">生成时间 (ms)</div>
                            <div class="stat-value">${generationTime}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">p 的位数</div>
                            <div class="stat-value">${p.toString(2).length}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">状态</div>
                            <div class="stat-value">就绪</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">密钥生成失败: ' + error.message + '</div>';
            }
        }
        
        // 清空密钥
        function clearKeys() {
            if (elgamal) {
                elgamal.clean();
                elgamal = null;
            }
            document.getElementById('keyResult').innerHTML = '';
            document.getElementById('keyStats').innerHTML = '';
            document.getElementById('encryptResult').innerHTML = '';
            document.getElementById('decryptResult').innerHTML = '';
            document.getElementById('fullTestResult').innerHTML = '';
        }
        
        // 生成随机消息
        function generateRandomMessage() {
            if (!elgamal) {
                alert('请先生成密钥对！');
                return;
            }
            
            try {
                const randomMsg = elgamal.getM();
                document.getElementById('plaintext').value = randomMsg.toString();
            } catch (error) {
                alert('生成随机消息失败: ' + error.message);
            }
        }
        
        // 加密消息
        function encryptMessage() {
            if (!elgamal) {
                alert('请先生成密钥对！');
                return;
            }
            
            const plaintext = document.getElementById('plaintext').value.trim();
            if (!plaintext) {
                alert('请输入要加密的消息！');
                return;
            }
            
            const resultDiv = document.getElementById('encryptResult');
            
            try {
                const startTime = performance.now();
                const message = BigInt(plaintext);
                const { c1, c2 } = elgamal.encrypt(message);
                const endTime = performance.now();
                
                // 自动填充解密输入框
                document.getElementById('c1Input').value = c1.toString();
                document.getElementById('c2Input').value = c2.toString();
                
                resultDiv.innerHTML = `
                    <div class="success">加密成功！耗时: ${(endTime - startTime).toFixed(2)}ms</div>
                    <div class="result">
                        <strong>原始消息:</strong> ${message.toString()}<br>
                        <strong>密文 c1:</strong> ${c1.toString()}<br>
                        <strong>密文 c2:</strong> ${c2.toString()}<br>
                        <strong>密文长度:</strong> c1: ${c1.toString().length} 字符, c2: ${c2.toString().length} 字符
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">加密失败: ' + error.message + '</div>';
            }
        }
        
        // 解密消息
        function decryptMessage() {
            if (!elgamal) {
                alert('请先生成密钥对！');
                return;
            }
            
            const c1Str = document.getElementById('c1Input').value.trim();
            const c2Str = document.getElementById('c2Input').value.trim();
            
            if (!c1Str || !c2Str) {
                alert('请输入完整的密文！');
                return;
            }
            
            const resultDiv = document.getElementById('decryptResult');
            
            try {
                const startTime = performance.now();
                const c1 = BigInt(c1Str);
                const c2 = BigInt(c2Str);
                const decrypted = elgamal.decrypt(c1, c2);
                const endTime = performance.now();
                
                resultDiv.innerHTML = `
                    <div class="success">解密成功！耗时: ${(endTime - startTime).toFixed(2)}ms</div>
                    <div class="result">
                        <strong>解密结果:</strong> ${decrypted.toString()}<br>
                        <strong>十六进制:</strong> 0x${decrypted.toString(16)}<br>
                        <strong>二进制位数:</strong> ${decrypted.toString(2).length}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">解密失败: ' + error.message + '</div>';
            }
        }
        
        // 完整测试
        function fullTest() {
            if (!elgamal) {
                alert('请先生成密钥对！');
                return;
            }
            
            let testMsg = document.getElementById('testMessage').value.trim();
            if (!testMsg) {
                testMsg = elgamal.getM().toString();
                document.getElementById('testMessage').value = testMsg;
            }
            
            const resultDiv = document.getElementById('fullTestResult');
            
            try {
                const message = BigInt(testMsg);
                
                // 加密
                const encryptStart = performance.now();
                const { c1, c2 } = elgamal.encrypt(message);
                const encryptEnd = performance.now();
                
                // 解密
                const decryptStart = performance.now();
                const decrypted = elgamal.decrypt(c1, c2);
                const decryptEnd = performance.now();
                
                // 验证
                const isValid = message === decrypted;
                
                resultDiv.innerHTML = `
                    <div class="${isValid ? 'success' : 'error'}">
                        ${isValid ? '✓ 完整测试通过！' : '✗ 测试失败：加密解密结果不匹配'}
                    </div>
                    <div class="result">
                        <strong>原始消息:</strong> ${message.toString()}<br>
                        <strong>加密耗时:</strong> ${(encryptEnd - encryptStart).toFixed(2)}ms<br>
                        <strong>解密耗时:</strong> ${(decryptEnd - decryptStart).toFixed(2)}ms<br>
                        <strong>总耗时:</strong> ${(encryptEnd - encryptStart + decryptEnd - decryptStart).toFixed(2)}ms<br>
                        <strong>解密结果:</strong> ${decrypted.toString()}<br>
                        <strong>结果匹配:</strong> ${isValid ? '是' : '否'}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">完整测试失败: ' + error.message + '</div>';
            }
        }
        
        // 批量测试
        async function batchTest() {
            if (!elgamal) {
                alert('请先生成密钥对！');
                return;
            }
            
            const resultDiv = document.getElementById('fullTestResult');
            resultDiv.innerHTML = '<div class="loading">正在进行批量测试...</div>';
            
            const testCount = 5;
            let successCount = 0;
            let totalEncryptTime = 0;
            let totalDecryptTime = 0;
            let results = [];
            
            try {
                for (let i = 0; i < testCount; i++) {
                    const message = elgamal.getM();
                    
                    // 加密
                    const encryptStart = performance.now();
                    const { c1, c2 } = elgamal.encrypt(message);
                    const encryptEnd = performance.now();
                    const encryptTime = encryptEnd - encryptStart;
                    
                    // 解密
                    const decryptStart = performance.now();
                    const decrypted = elgamal.decrypt(c1, c2);
                    const decryptEnd = performance.now();
                    const decryptTime = decryptEnd - decryptStart;
                    
                    // 验证
                    const isValid = message === decrypted;
                    if (isValid) successCount++;
                    
                    totalEncryptTime += encryptTime;
                    totalDecryptTime += decryptTime;
                    
                    results.push({
                        test: i + 1,
                        message: message.toString().substring(0, 20) + '...',
                        encryptTime: encryptTime.toFixed(2),
                        decryptTime: decryptTime.toFixed(2),
                        valid: isValid
                    });
                    
                    // 让界面更新
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                const avgEncryptTime = (totalEncryptTime / testCount).toFixed(2);
                const avgDecryptTime = (totalDecryptTime / testCount).toFixed(2);
                
                let resultsHtml = results.map(r => 
                    `测试 ${r.test}: ${r.valid ? '✓' : '✗'} (加密: ${r.encryptTime}ms, 解密: ${r.decryptTime}ms)`
                ).join('<br>');
                
                resultDiv.innerHTML = `
                    <div class="${successCount === testCount ? 'success' : 'error'}">
                        批量测试完成：${successCount}/${testCount} 个测试通过
                    </div>
                    <div class="result">
                        <strong>成功率:</strong> ${((successCount/testCount)*100).toFixed(1)}%<br>
                        <strong>平均加密时间:</strong> ${avgEncryptTime}ms<br>
                        <strong>平均解密时间:</strong> ${avgDecryptTime}ms<br>
                        <strong>总测试时间:</strong> ${(totalEncryptTime + totalDecryptTime).toFixed(2)}ms<br><br>
                        <strong>详细结果:</strong><br>
                        ${resultsHtml}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">批量测试失败: ' + error.message + '</div>';
            }
        }
        
        // 性能测试
        async function performanceTest() {
            if (!elgamal) {
                alert('请先生成密钥对！');
                return;
            }
            
            const testCount = parseInt(document.getElementById('perfTestCount').value);
            const resultDiv = document.getElementById('perfResult');
            
            resultDiv.innerHTML = `<div class="loading">正在进行 ${testCount} 次性能测试...</div>`;
            
            try {
                let encryptTimes = [];
                let decryptTimes = [];
                
                for (let i = 0; i < testCount; i++) {
                    const message = elgamal.getM();
                    
                    // 测试加密性能
                    const encryptStart = performance.now();
                    const { c1, c2 } = elgamal.encrypt(message);
                    const encryptEnd = performance.now();
                    encryptTimes.push(encryptEnd - encryptStart);
                    
                    // 测试解密性能
                    const decryptStart = performance.now();
                    const decrypted = elgamal.decrypt(c1, c2);
                    const decryptEnd = performance.now();
                    decryptTimes.push(decryptEnd - decryptStart);
                    
                    // 让界面更新
                    if (i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                // 计算统计数据
                const avgEncrypt = (encryptTimes.reduce((a, b) => a + b, 0) / testCount).toFixed(2);
                const avgDecrypt = (decryptTimes.reduce((a, b) => a + b, 0) / testCount).toFixed(2);
                const minEncrypt = Math.min(...encryptTimes).toFixed(2);
                const maxEncrypt = Math.max(...encryptTimes).toFixed(2);
                const minDecrypt = Math.min(...decryptTimes).toFixed(2);
                const maxDecrypt = Math.max(...decryptTimes).toFixed(2);
                
                resultDiv.innerHTML = `
                    <div class="success">性能测试完成！</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-label">测试次数</div>
                            <div class="stat-value">${testCount}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">平均加密时间</div>
                            <div class="stat-value">${avgEncrypt}ms</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">平均解密时间</div>
                            <div class="stat-value">${avgDecrypt}ms</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">加密时间范围</div>
                            <div class="stat-value">${minEncrypt}-${maxEncrypt}ms</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">解密时间范围</div>
                            <div class="stat-value">${minDecrypt}-${maxDecrypt}ms</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">总耗时</div>
                            <div class="stat-value">${(parseFloat(avgEncrypt) + parseFloat(avgDecrypt)).toFixed(2)}ms</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">性能测试失败: ' + error.message + '</div>';
            }
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ElGamal 测试页面已加载');
        });
    </script>
</body>
</html>