<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同态加密匹配系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fhe.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔒 同态加密匹配系统</h1>
            <p>基于ElGamal同态加密的隐私保护匹配平台</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('init')">系统初始化</button>
            <button class="nav-tab" onclick="switchTab('send')">发送匹配请求</button>
            <button class="nav-tab" onclick="switchTab('requests')">处理请求</button>
            <button class="nav-tab" onclick="switchTab('results')">匹配结果</button>
        </div>

        <!-- 系统初始化标签页 -->
        <div id="init" class="tab-content active">
            <div class="security-info">
                <h4>🛡️ 安全特性</h4>
                <ul>
                    <li>使用ElGamal同态加密保护用户选择</li>
                    <li>Diffie-Hellman密钥交换确保通信安全</li>
                    <li>联系方式与匹配结果同态绑定</li>
                    <li>平台无法获知用户真实选择和联系方式</li>
                    <li>只有双方都同意时才能获得对方联系方式</li>
                </ul>
            </div>

            <div class="card">
                <h3>📝 初始化用户加密参数</h3>
                <p class="mb-3">设置您的联系方式并生成加密密钥对</p>
                
                <div class="form-group">
                    <label for="contactInfo">联系方式 (邮箱/电话/微信等)</label>
                    <input type="text" id="contactInfo" class="form-control" 
                           placeholder="例如: alice@example.com 或 微信号: alice123">
                </div>
                
                <button class="btn btn-primary" onclick="initUser()">🔑 初始化加密系统</button>
                
                <div id="initResult"></div>
            </div>
        </div>

        <!-- 发送匹配请求标签页 -->
        <div id="send" class="tab-content">
            <div class="card">
                <h3>💕 发送匹配请求</h3>
                <p class="mb-3">向其他用户发送加密的匹配请求</p>
                
                <div class="form-group user-search">
                    <label for="targetUser">目标用户</label>
                    <input type="text" id="targetUser" class="form-control" 
                           placeholder="输入用户名进行搜索..." oninput="searchUsers(this.value)">
                    <div id="searchResults" class="search-results" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label>您的选择</label>
                    <div>
                        <label style="font-weight: normal; margin-right: 20px;">
                            <input type="radio" name="choice" value="true" checked> 
                            ✅ 接受匹配
                        </label>
                        <label style="font-weight: normal;">
                            <input type="radio" name="choice" value="false"> 
                            ❌ 拒绝匹配
                        </label>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        注意：您的选择将被加密，平台无法得知
                    </small>
                </div>
                
                <button class="btn btn-primary" onclick="sendMatchRequest()">🚀 发送加密匹配请求</button>
                
                <div id="sendResult"></div>
            </div>
        </div>

        <!-- 处理请求标签页 -->
        <div id="requests" class="tab-content">
            <div class="card">
                <h3>📬 待处理的匹配请求</h3>
                <p class="mb-3">查看并响应其他用户的匹配请求</p>
                
                <button class="btn btn-secondary" onclick="loadMatchRequests()">🔄 刷新请求列表</button>
                
                <div id="requestsList"></div>
            </div>
        </div>

        <!-- 匹配结果标签页 -->
        <div id="results" class="tab-content">
            <div class="card">
                <h3>🎯 匹配结果</h3>
                <p class="mb-3">查看并解密您的匹配结果</p>
                
                <button class="btn btn-secondary" onclick="loadMatchResults()">🔄 刷新结果列表</button>
                
                <div id="resultsList"></div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let availableUsers = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            getCurrentUser();
            loadAvailableUsers();
        });

        // 获取当前用户信息
        async function getCurrentUser() {
            try {
                const response = await fetch('/api/auth/profile');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
            }
        }

        // 加载可用用户列表
        async function loadAvailableUsers() {
            try {
                const response = await fetch('/api/matching/users');
                if (response.ok) {
                    const data = await response.json();
                    availableUsers = data.users || [];
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签按钮的激活状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // 根据标签页加载相应数据
            if (tabName === 'requests') {
                loadMatchRequests();
            } else if (tabName === 'results') {
                loadMatchResults();
            }
        }

        // 用户搜索
        function searchUsers(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const filtered = availableUsers.filter(user => 
                user.username.toLowerCase().includes(query.toLowerCase()) ||
                (user.nickname && user.nickname.toLowerCase().includes(query.toLowerCase()))
            );

            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map(user => `
                    <div class="search-result-item" onclick="selectUser('${user.username}')">
                        <strong>${user.username}</strong>
                        ${user.nickname ? `(${user.nickname})` : ''}
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        // 选择用户
        function selectUser(username) {
            document.getElementById('targetUser').value = username;
            document.getElementById('searchResults').style.display = 'none';
        }

        // 初始化用户
        async function initUser() {
            const contactInfo = document.getElementById('contactInfo').value.trim();
            
            if (!contactInfo) {
                showResult('initResult', '请输入联系方式', 'error');
                return;
            }

            try {
                showResult('initResult', '正在初始化加密系统...', 'info');
                
                const response = await fetch('/api/fhe/init_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contact_info: contactInfo
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('initResult', `
                        <div class="alert-success">
                            ✅ 初始化成功！<br>
                            📧 联系方式已设置: ${contactInfo}<br>
                            🔑 公钥: ${data.public_key.substring(0, 20)}...<br>
                            🔒 您的加密参数已生成，可以开始匹配了！
                        </div>
                    `, 'success');
                } else {
                    showResult('initResult', data.message, 'error');
                }
            } catch (error) {
                showResult('initResult', '初始化失败: ' + error.message, 'error');
            }
        }

        // 发送匹配请求
        async function sendMatchRequest() {
            const targetUser = document.getElementById('targetUser').value.trim();
            const choice = document.querySelector('input[name="choice"]:checked').value === 'true';
            
            if (!targetUser) {
                showResult('sendResult', '请选择目标用户', 'error');
                return;
            }

            try {
                showResult('sendResult', '正在发送加密匹配请求...', 'info');
                
                const response = await fetch('/api/fhe/send_match_request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_username: targetUser,
                        choice: choice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('sendResult', `
                        <div class="alert-success">
                            ✅ 匹配请求发送成功！<br>
                            🎯 目标用户: ${targetUser}<br>
                            🔒 您的选择已加密发送<br>
                            📝 请求ID: ${data.request_id}<br>
                            ⏰ 等待对方响应...
                        </div>
                    `, 'success');
                    
                    // 清空表单
                    document.getElementById('targetUser').value = '';
                } else {
                    showResult('sendResult', data.message, 'error');
                }
            } catch (error) {
                showResult('sendResult', '发送失败: ' + error.message, 'error');
            }
        }

        // 加载匹配请求
        async function loadMatchRequests() {
            try {
                const response = await fetch('/api/fhe/get_match_requests');
                const data = await response.json();
                
                if (data.success) {
                    const requestsList = document.getElementById('requestsList');
                    
                    if (data.requests.length === 0) {
                        requestsList.innerHTML = '<p class="text-center">暂无待处理的匹配请求</p>';
                        return;
                    }

                    requestsList.innerHTML = data.requests.map(req => `
                        <div class="request-item">
                            <h4>💌 来自 ${req.requester_name} (${req.requester_id}) 的匹配请求</h4>
                            <p>📅 时间: ${new Date(req.created_at).toLocaleString()}</p>
                            <p>🔒 对方的选择已加密，您需要做出回应来完成匹配计算</p>
                            
                            <div style="margin-top: 15px;">
                                <label style="font-weight: normal; margin-right: 20px;">
                                    <input type="radio" name="response_${req.request_id}" value="true" checked> 
                                    ✅ 接受匹配
                                </label>
                                <label style="font-weight: normal;">
                                    <input type="radio" name="response_${req.request_id}" value="false"> 
                                    ❌ 拒绝匹配
                                </label>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="respondToRequest(${req.request_id}, true)">
                                    ✅ 接受并处理
                                </button>
                                <button class="btn btn-danger" onclick="respondToRequest(${req.request_id}, false)">
                                    ❌ 拒绝并处理
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('requestsList').innerHTML = 
                        `<p class="alert-error">加载失败: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('requestsList').innerHTML = 
                    `<p class="alert-error">加载失败: ${error.message}</p>`;
            }
        }

        // 响应匹配请求
        async function respondToRequest(requestId, choice) {
            try {
                const response = await fetch('/api/fhe/respond_match_request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        choice: choice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`✅ 处理成功！\n匹配结果ID: ${data.match_result_id}\n请到"匹配结果"页面查看和解密结果`);
                    loadMatchRequests(); // 刷新列表
                } else {
                    alert('❌ 处理失败: ' + data.message);
                }
            } catch (error) {
                alert('❌ 处理失败: ' + error.message);
            }
        }

        // 加载匹配结果
        async function loadMatchResults() {
            try {
                const response = await fetch('/api/fhe/get_match_results');
                const data = await response.json();
                
                if (data.success) {
                    const resultsList = document.getElementById('resultsList');
                    
                    if (data.results.length === 0) {
                        resultsList.innerHTML = '<p class="text-center">暂无匹配结果</p>';
                        return;
                    }

                    resultsList.innerHTML = data.results.map(result => `
                        <div class="result-item">
                            <h4>🎯 与 ${result.other_name} (${result.other_user}) 的匹配</h4>
                            <p>📅 时间: ${new Date(result.created_at).toLocaleString()}</p>
                            <p>🔒 匹配结果已加密，点击解密查看结果</p>
                            
                            <button class="btn btn-primary" onclick="decryptResult(${result.match_result_id})">
                                🔓 解密匹配结果
                            </button>
                            
                            <div id="result_${result.match_result_id}"></div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('resultsList').innerHTML = 
                        `<p class="alert-error">加载失败: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('resultsList').innerHTML = 
                    `<p class="alert-error">加载失败: ${error.message}</p>`;
            }
        }

        // 解密匹配结果
        async function decryptResult(matchResultId) {
            try {
                const resultDiv = document.getElementById(`result_${matchResultId}`);
                resultDiv.innerHTML = '<p class="loading">🔓 正在解密匹配结果...</p>';
                
                const response = await fetch('/api/fhe/decrypt_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        match_result_id: matchResultId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.is_match && data.contact_info) {
                        resultDiv.innerHTML = `
                            <div class="alert-success" style="margin-top: 15px;">
                                🎉 匹配成功！双方都同意了匹配<br>
                                📞 对方联系方式: 
                                <div class="contact-display">${data.contact_info}</div>
                                💡 您现在可以联系对方了！
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert-info" style="margin-top: 15px;">
                                😔 匹配失败<br>
                                ${data.message}<br>
                                🔒 基于隐私保护，无法获得对方联系方式
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-error" style="margin-top: 15px;">
                            ❌ 解密失败: ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById(`result_${matchResultId}`).innerHTML = `
                    <div class="alert-error" style="margin-top: 15px;">
                        ❌ 解密失败: ${error.message}
                    </div>
                `;
            }
        }

        // 显示结果消息
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-error' : 'alert-info';
            
            element.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }

        // 点击其他地方隐藏搜索结果
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-search')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });
    </script>
</body>
</html>