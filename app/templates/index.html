<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘æ‹åŒ¹é…ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’• åŒ¹é…ç³»ç»Ÿ</h1>
            <div class="user-info">
                <span id="currentUser">åŠ è½½ä¸­...</span>
                <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <ul class="nav-menu">
                    <li><a href="#" class="active" onclick="showSection('dashboard')">ğŸ  ä»ªè¡¨æ¿</a></li>
                    <li><a href="#" onclick="showSection('profile')">ğŸ‘¤ ä¸ªäººèµ„æ–™</a></li>
                    <li><a href="#" onclick="showSection('preferences')">âš™ï¸ åŒ¹é…åå¥½</a></li>
                    <li><a href="#" onclick="showSection('pushes')">ğŸ’Œ ä»Šæ—¥æ¨é€</a></li>
                    <li><a href="#" onclick="showSection('matches')">ğŸ’• æˆ‘çš„åŒ¹é…</a></li>
                    <li><a href="#" onclick="showSection('histories')">ğŸ“™ åŒ¹é…å†å²</a></li>
                </ul>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="todayPushes">-</h3>
                        <p>ä»Šæ—¥æ¨é€</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pendingPushes">-</h3>
                        <p>å¾…å¤„ç†</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalMatches">-</h3>
                        <p>æ€»åŒ¹é…</p>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- ä»ªè¡¨æ¿éƒ¨åˆ† -->
                <div id="dashboard" class="section active">
                    <h2>ğŸ  ä»ªè¡¨æ¿</h2>
                    <div id="profileStatus"></div>
                    <div id="dashboardContent">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <!-- ä¸ªäººèµ„æ–™éƒ¨åˆ† -->
                <div id="profile" class="section">
                    <h2>ğŸ‘¤ ä¸ªäººèµ„æ–™</h2>
                    <form id="profileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nickname">æ˜µç§° *</label>
                                <input type="text" id="nickname" name="nickname" required>
                            </div>
                            <div class="form-group">
                                <label for="age">å¹´é¾„ *</label>
                                <input type="number" id="age" name="age" min="18" max="50" required value="18">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="gender">æ€§åˆ« *</label>
                                <select id="gender" name="gender" required>
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="male">ç”·</option>
                                    <option value="female">å¥³</option>
                                    <option value="other" selected>å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="height">èº«é«˜ (cm)</label>
                                <input type="number" id="height" name="height" min="120" max="250" value="170">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="weight">ä½“é‡ (kg)</label>
                                <input type="number" id="weight" name="weight" min="40" max="150" step="0.1" value="60">
                            </div>
                            <div class="form-group">
                                <label for="education">å­¦å†</label>
                                <select id="education" name="education">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="bachelor">æœ¬ç§‘</option>
                                    <option value="master">ç¡•å£«</option>
                                    <option value="phd">åšå£«</option>
                                    <option value="other" selected>å…¶ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="hobbies">å…´è¶£çˆ±å¥½</label>
                            <input type="text" id="hobbies" name="hobbies" placeholder="å¦‚ï¼šéŸ³ä¹ã€è¿åŠ¨ã€é˜…è¯»ç­‰">
                        </div>

                        <div class="form-group">
                            <label for="bio">ä¸ªäººç®€ä»‹ *</label>
                            <textarea id="bio" name="bio" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="contact_info">è”ç³»æ–¹å¼</label>
                            <input type="text" id="contact_info" name="contact_info" placeholder="QQã€å¾®ä¿¡ç­‰">
                        </div>

                        <button type="submit" class="btn">ä¿å­˜èµ„æ–™</button>
                    </form>
                </div>

                <!-- åŒ¹é…åå¥½éƒ¨åˆ† -->
                <div id="preferences" class="section">
                    <h2>âš™ï¸ åŒ¹é…åå¥½</h2>
                    <form id="preferencesForm">
                        <div class="form-group">
                            <label for="preferredGender">æœŸæœ›æ€§åˆ«</label>
                            <select id="preferredGender" name="preferred_gender">
                                <option value="">æ— åå¥½</option>
                                <option value="male">ç”·</option>
                                <option value="female">å¥³</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="minAge">æœ€å°å¹´é¾„</label>
                                <input type="number" id="minAge" name="min_age" min="18" max="50">
                            </div>
                            <div class="form-group">
                                <label for="maxAge">æœ€å¤§å¹´é¾„</label>
                                <input type="number" id="maxAge" name="max_age" min="18" max="50">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="minHeight">æœ€å°èº«é«˜ (cm)</label>
                                <input type="number" id="minHeight" name="min_height" min="150" max="200">
                            </div>
                            <div class="form-group">
                                <label for="maxHeight">æœ€å¤§èº«é«˜ (cm)</label>
                                <input type="number" id="maxHeight" name="max_height" min="150" max="200">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="dealBreakers">æ‹’ç»æ¡ä»¶</label>
                            <textarea id="dealBreakers" name="deal_breakers" placeholder="æè¿°ä½ çš„æ‹’ç»æ¡ä»¶..."></textarea>
                        </div>

                        <button type="submit" class="btn">ä¿å­˜åå¥½</button>
                    </form>
                </div>

                <!-- ä»Šæ—¥æ¨é€éƒ¨åˆ† -->
                <div id="pushes" class="section">
                    <h2>ğŸ’Œ ä»Šæ—¥æ¨é€</h2>
                    <div class="push-actions" style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="generatePushes()">ç”Ÿæˆæ–°æ¨é€</button>
                        <button class="btn btn-secondary" onclick="forceReload()">åˆ·æ–°</button>
                    </div>
                    <div id="pushesContent">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <!-- æˆ‘çš„åŒ¹é…éƒ¨åˆ† -->
                <div id="matches" class="section">
                    <h2>ğŸ’• ç»“æœæŸ¥è¯¢</h2>
                    <div id="matchesContent">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <!-- åŒ¹é…å†å²éƒ¨åˆ† -->
                <div id="histories" class="section">
                    <h2>ğŸ“™ åŒ¹é…å†å²</h2>
                    <div id="historiesContent">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/secureElgamal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/fhe.js') }}"></script>
    <script src="{{ url_for('static', filename='js/CryptoJS/rollups/aes.js') }}"></script>
    <script src="{{ url_for('static', filename='js/CryptoJS/components/mode-ecb.js') }}"></script>
    <script src="{{ url_for('static', filename='js/CryptoJS/components/pad-nopadding.js') }}"></script>

    <script>
        let secureElgamal = new SecureElGamal(512);
        let currentUser = null;
        let currentSession = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„session
                const session = secureElgamal.getCurrentSession();
                if (!session.sessionId || !session.username) {
                    window.location.href = '/';
                    return;
                }

                // éªŒè¯sessionæ˜¯å¦æœ‰æ•ˆ
                const isValid = await secureElgamal.validateSession(session.sessionId);
                if (!isValid) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/';
                    return;
                }

                currentUser = session.username;
                currentSession = session.sessionId;

                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                document.getElementById('currentUser').textContent = `æ¬¢è¿ï¼Œ${currentUser}`;

                // åŠ è½½åˆå§‹æ•°æ®
                await loadStats();
                await loadDashboard();

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/';
            }
        });

        // æ˜¾ç¤ºä¸åŒçš„éƒ¨åˆ†
        function showSection(sectionName) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰èœå•é¡¹çš„activeç±»
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
            document.getElementById(sectionName).classList.add('active');

            // æ¿€æ´»å¯¹åº”çš„èœå•é¡¹
            event.target.classList.add('active');

            // åŠ è½½å¯¹åº”çš„å†…å®¹
            loadSectionContent(sectionName);
        }

        // åŠ è½½éƒ¨åˆ†å†…å®¹
        async function loadSectionContent(sectionName) {
            switch (sectionName) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'profile':
                    await loadProfile();
                    break;
                case 'preferences':
                    await loadPreferences();
                    break;
                case 'pushes':
                    await loadPushes();
                    break;
                case 'matches':
                    await loadMatches();
                    break;
                case 'histories':
                    await loadHistory();
                    break;
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/api/stats', {
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('todayPushes').textContent = data.stats.today_pushes;
                    document.getElementById('pendingPushes').textContent = data.stats.pending_pushes;
                    document.getElementById('totalMatches').textContent = data.stats.total_matches;
                } else {
                    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿
        async function loadDashboard() {
            try {
                // æ£€æŸ¥èµ„æ–™å®Œæ•´æ€§
                const profileResponse = await fetch('/api/profile_status', {
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const profileData = await profileResponse.json();
                const profileStatusEl = document.getElementById('profileStatus');

                if (!profileData.profile_complete) {
                    profileStatusEl.innerHTML = `
                        <div class="profile-completion">
                            <h3>âš ï¸ è¯·å®Œå–„æ‚¨çš„ä¸ªäººèµ„æ–™</h3>
                            <p>æ‚¨éœ€è¦å®Œå–„ä»¥ä¸‹ä¿¡æ¯æ‰èƒ½å¼€å§‹åŒ¹é…ï¼š</p>
                            <ul style="margin: 10px 0 15px 20px;">
                                ${profileData.missing_fields.map(field => `<li>${getFieldName(field)}</li>`).join('')}
                            </ul>
                            <button class="btn btn-warning" onclick="showSection('profile')">ç«‹å³å®Œå–„</button>
                        </div>
                    `;
                } else {
                    profileStatusEl.innerHTML = `
                        <div class="alert alert-success">
                            âœ… æ‚¨çš„èµ„æ–™å·²å®Œå–„ï¼Œå¯ä»¥å¼€å§‹æ¥æ”¶åŒ¹é…æ¨é€äº†ï¼
                        </div>
                    `;
                }

                // æ˜¾ç¤ºä»Šæ—¥æ¨é€æ¦‚è§ˆ
                await loadPushesPreview();

            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿å¤±è´¥:', error);
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // åŠ è½½æ¨é€é¢„è§ˆ
        async function loadPushesPreview() {
            try {
                const response = await fetch('/api/daily_pushes', {
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();
                const contentEl = document.getElementById('dashboardContent');

                if (data.success) {
                    if (data.pushes.length > 0) {
                        const latestPush = data.pushes[0];
                        contentEl.innerHTML += `
                            <div class="push-card">
                                <h3>ğŸ’Œ æœ€æ–°æ¨é€</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <strong>æ˜µç§°</strong>
                                        <span>${latestPush.user_info.nickname}</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>å¹´é¾„</strong>
                                        <span>${latestPush.user_info.age || 'æœªçŸ¥'}</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>æ€§åˆ«</strong>
                                        <span>${getGenderText(latestPush.user_info.gender)}</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>èº«é«˜</strong>
                                        <span>${latestPush.user_info.height || 'æœªçŸ¥'}cm</span>
                                    </div>
                                </div>
                                <div class="push-actions">
                                    <button class="btn btn-success" onclick="showSection('pushes')">æŸ¥çœ‹æ‰€æœ‰æ¨é€</button>
                                </div>
                            </div>
                        `;
                    } else {
                        contentEl.innerHTML += `
                            <div class="empty-state">
                                <h3>ğŸ˜´ ä»Šæ—¥æš‚æ— æ¨é€</h3>
                                <p>ç‚¹å‡»"ç”Ÿæˆæ–°æ¨é€"æŒ‰é’®è·å–åŒ¹é…å¯¹è±¡</p>
                                <button class="btn btn-success" onclick="generatePushes()">ç”Ÿæˆæ–°æ¨é€</button>
                            </div>
                        `;
                    }
                } else {
                    contentEl.innerHTML += `
                        <div class="alert alert-warning">${data.message}</div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ¨é€é¢„è§ˆå¤±è´¥:', error);
            }
        }

        // åŠ è½½ä¸ªäººèµ„æ–™
        async function loadProfile() {
            try {
                const response = await fetch('/api/profile_status', {
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const profile = data.profile_data;

                    // å¡«å……è¡¨å•
                    document.getElementById('nickname').value = profile.nickname || '';
                    document.getElementById('age').value = profile.age || '';
                    document.getElementById('gender').value = profile.gender || '';
                    document.getElementById('height').value = profile.height || '';
                    document.getElementById('weight').value = profile.weight || '';
                    document.getElementById('education').value = profile.education || '';
                    document.getElementById('hobbies').value = profile.hobbies || '';
                    document.getElementById('bio').value = profile.bio || '';

                    // contact_info ä»æœ¬åœ°å­˜å‚¨è·å–
                    const localContactInfo = getLocalContactInfo();
                    document.getElementById('contact_info').value = localContactInfo || '';
                }
            } catch (error) {
                console.error('åŠ è½½ä¸ªäººèµ„æ–™å¤±è´¥:', error);
            }
        }

        // åŠ è½½åŒ¹é…åå¥½
        async function loadPreferences() {
            try {
                const response = await fetch('/api/match_preferences', {
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();

                if (data.success && data.preferences) {
                    const prefs = data.preferences;

                    // å¡«å……è¡¨å•
                    document.getElementById('preferredGender').value = prefs.preferred_gender || '';
                    document.getElementById('minAge').value = prefs.min_age || '';
                    document.getElementById('maxAge').value = prefs.max_age || '';
                    document.getElementById('minHeight').value = prefs.min_height || '';
                    document.getElementById('maxHeight').value = prefs.max_height || '';
                    document.getElementById('dealBreakers').value = prefs.deal_breakers || '';
                }
            } catch (error) {
                console.error('åŠ è½½åŒ¹é…åå¥½å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ¨é€åˆ—è¡¨
        async function loadPushes() {
            try {
                const response = await fetch('/api/daily_pushes', {
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();
                const contentEl = document.getElementById('pushesContent');

                if (data.success) {
                    if (data.pushes.length > 0) {
                        const push = data.pushes[0];
                        const user_y = `${push.user_info.username}_y`;
                        localStorage.setItem(user_y, push.user_info.user_y);
                        contentEl.innerHTML = `
                            <div class="current-push">
                                <h3>ğŸ’Œ å½“å‰æ¨é€</h3>
                                <div class="push-card">
                                    <h4>${push.user_info.nickname}</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <strong>å¹´é¾„</strong>
                                            <span>${push.user_info.age || 'æœªçŸ¥'}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>æ€§åˆ«</strong>
                                            <span>${getGenderText(push.user_info.gender)}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>èº«é«˜</strong>
                                            <span>${push.user_info.height || 'æœªçŸ¥'}cm</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>æ•™è‚²</strong>
                                            <span>${getEducationText(push.user_info.education)}</span>
                                        </div>
                                    </div>
                                    ${push.user_info.hobbies ? `<p><strong>å…´è¶£çˆ±å¥½ï¼š</strong>${push.user_info.hobbies}</p>` : ''}
                                    ${push.user_info.bio ? `<p><strong>ä¸ªäººç®€ä»‹ï¼š</strong>${push.user_info.bio}</p>` : ''}
                                    
                                    <div class="push-actions">
                                        <button class="btn btn-success" onclick="respondToPush(${push.push_id}, '${push.user_info.username}', 'accepted')">ğŸ’• æ¥å—</button>
                                        <button class="btn btn-secondary" onclick="respondToPush(${push.push_id}, '${push.user_info.username}', 'rejected')">âŒ æ‹’ç»</button>
                                    </div>
                                </div>
                                <div class="push-hint">
                                    <p>ğŸ“ è¯·é€‰æ‹©æ¥å—æˆ–æ‹’ç»ï¼Œå¤„ç†å®Œå½“å‰æ¨é€åæ‰èƒ½è·å¾—ä¸‹ä¸€æ¡æ¨é€</p>
                                </div>
                            </div>
                        `;
                    } else {
                        contentEl.innerHTML = `
                            <div class="empty-state">
                                <h3>ğŸ˜´ å½“å‰æ²¡æœ‰å¾…å¤„ç†çš„æ¨é€</h3>
                                <p>ç‚¹å‡»"ç”Ÿæˆæ–°æ¨é€"æŒ‰é’®è·å–åŒ¹é…å¯¹è±¡</p>
                                <div class="empty-actions">
                                    <button class="btn btn-success" onclick="generatePushes()">ç”Ÿæˆæ–°æ¨é€</button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    contentEl.innerHTML = `
                        <div class="alert alert-warning">${data.message}</div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ¨é€å¤±è´¥:', error);
                contentEl.innerHTML = `
                    <div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // åŠ è½½åŒ¹é…åˆ—è¡¨
        async function loadMatches() {
            const contentEl = document.getElementById('matchesContent');

            contentEl.innerHTML = `
                <div class="fhe-match-section">
                    <h3>ğŸ”’ åŒ¹é…ç»“æœæŸ¥è¯¢</h3>
                    <div class="fhe-controls">
                        <div class="form-group">
                            <label for="fheUsername">å¯¹æ–¹ç”¨æˆ·å:</label>
                            <input type="text" id="fheUsername" placeholder="è¾“å…¥å¯¹æ–¹çš„ç”¨æˆ·å">
                        </div>
                        <button class="btn btn-primary" onclick="handleFheMatchQuery()">æŸ¥è¯¢åŒ¹é…ç»“æœ</button>
                    </div>
                    <div id="fheResultDisplay" class="fhe-result-container">
                        <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            `;
        }

        // å¤„ç†FHEåŒ¹é…æŸ¥è¯¢
        async function handleFheMatchQuery() {
            const username = document.getElementById('fheUsername').value;
            const resultContainer = document.getElementById('fheResultDisplay');
            
            if (!username) {
                resultContainer.innerHTML = `
                    <div class="alert alert-warning">
                        âš ï¸ è¯·è¾“å…¥å¯¹æ–¹çš„ç”¨æˆ·å
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultContainer.innerHTML = `
                <div class="loading">
                    ğŸ”„ æ­£åœ¨æŸ¥è¯¢ç»“æœ...
                </div>
            `;

            try {
                // 1. è·å–åŸå§‹åŠ å¯†æ•°æ®
                const result = await get_fhe_match_res(username);

                console.log('æŸ¥è¯¢ç”¨æˆ·:', username);
                console.log('ä»åç«¯è·å–çš„åŸå§‹æ•°æ®:', result);

                if (!result || !result.success) {
                    resultContainer.innerHTML = `
                        <div class="alert alert-error">
                            âŒ æœªèƒ½è·å–åˆ°æœ‰æ•ˆçš„ç»“æœ
                        </div>
                    `;
                    return;
                }

                // 2. åˆå§‹åŒ–FHEå¹¶è§£å¯†æ•°æ®
                const fhe = new FHE(currentUser);
                fhe.load_params();

                // è®¡ç®—å…±äº«å¯†é’¥ï¼ˆéœ€è¦å¯¹æ–¹çš„å…¬é’¥ï¼‰
                const user_y = localStorage.getItem(`${username}_y`);
                if (!user_y) {
                    resultContainer.innerHTML = `
                        <div class="alert alert-error">
                            âŒ ç¼ºå°‘ä¸ç”¨æˆ· ${username} çš„å¯†é’¥äº¤æ¢ä¿¡æ¯ï¼Œè¯·å…ˆä¸è¯¥ç”¨æˆ·è¿›è¡ŒåŒ¹é…æ“ä½œ
                        </div>
                    `;
                    return;
                }

                await fhe.compute_shared_secret(user_y);

                // 3. è§£å¯†FHEç»“æœ
                const decryptedResult = await fhe.processFheMatchResponse(result);

                // 4. æ˜¾ç¤ºè§£å¯†åçš„ç»“æœ
                displayDecryptedResult(resultContainer, username, decryptedResult);

            } catch (error) {
                console.error('æŸ¥è¯¢ç»“æœå¤±è´¥:', error);
                resultContainer.innerHTML = `
                    <div class="alert alert-error">
                        âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºè§£å¯†åçš„ç»“æœ
        function displayDecryptedResult(container, username, decryptedResult) {
            const { isMatch, decryptedValue, contactInfo, rawResult } = decryptedResult;

            let resultHtml = `
                <div class="fhe-result-success">
                    <h4>âœ… ç»“æœè§£å¯†å®Œæˆ</h4>
                    <div class="result-content">
                        <div class="match-result ${isMatch ? 'match-success' : 'match-failed'}">
                            <h5>ğŸ¯ åŒ¹é…ç»“æœ</h5>
                            <p class="match-status">
                                ${isMatch ? 'ğŸ‰ åŒ¹é…æˆåŠŸï¼' : 'ğŸ’” å¯¹æ–¹å°šæœªè¿›è¡ŒåŒ¹é…é€‰æ‹©ï¼Œæˆ–è‡³å°‘æœ‰ä¸€æ–¹é€‰æ‹©äº†æ‹’ç»'}
                            </p>
                            <p class="decrypt-value">è§£å¯†å€¼: ${decryptedValue}</p>
                        </div>
            `;

            if (isMatch && contactInfo) {
                resultHtml += `
                        <div class="contact-info match-success">
                            <h5>ğŸ“ è”ç³»æ–¹å¼</h5>
                            <p class="contact-text">${contactInfo}</p>
                            <p class="contact-hint">ğŸ”’ è”ç³»æ–¹å¼å·²å®‰å…¨è§£å¯†ï¼Œä»…åœ¨åŒæ–¹åŒ¹é…æˆåŠŸæ—¶å¯è§</p>
                        </div>
                `;
            } else if (isMatch && !contactInfo) {
                resultHtml += `
                        <div class="contact-info contact-error">
                            <h5>ğŸ“ è”ç³»æ–¹å¼</h5>
                            <p class="contact-error">âš ï¸ æ— æ³•è§£å¯†è”ç³»æ–¹å¼æˆ–å¯¹æ–¹æœªæä¾›è”ç³»æ–¹å¼</p>
                        </div>
                `;
            }

            // æ˜¾ç¤ºåŸå§‹æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
            resultHtml += `
                        <details class="raw-data">
                            <summary>ğŸ” æŸ¥çœ‹åŸå§‹åŠ å¯†æ•°æ®</summary>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(rawResult, null, 2)}</pre>
                        </details>
                    </div>
                </div>
            `;

            container.innerHTML = resultHtml;
        }

        // æœ¬åœ°å­˜å‚¨è”ç³»æ–¹å¼çš„ç›¸å…³å‡½æ•°
        function getLocalContactInfo() {
            try {
                const key = `contact_info_${currentUser}`;
                return localStorage.getItem(key) || '';
            } catch (error) {
                console.error('è·å–æœ¬åœ°è”ç³»æ–¹å¼å¤±è´¥:', error);
                return '';
            }
        }

        function saveLocalContactInfo(contactInfo) {
            try {
                const key = `contact_info_${currentUser}`;
                if (contactInfo) {
                    localStorage.setItem(key, contactInfo);
                } else {
                    localStorage.removeItem(key);
                }
                return true;
            } catch (error) {
                console.error('ä¿å­˜æœ¬åœ°è”ç³»æ–¹å¼å¤±è´¥:', error);
                return false;
            }
        }

        // ä¿å­˜ä¸ªäººèµ„æ–™
        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const profileData = Object.fromEntries(formData);

            // å…ˆä¿å­˜è”ç³»æ–¹å¼åˆ°æœ¬åœ°å­˜å‚¨
            const contactInfo = profileData.contact_info;
            saveLocalContactInfo(contactInfo);

            // ä»è¦å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®ä¸­ç§»é™¤ contact_info
            delete profileData.contact_info;

            // è½¬æ¢æ•°å€¼ç±»å‹
            if (profileData.age) profileData.age = parseInt(profileData.age);
            if (profileData.height) profileData.height = parseInt(profileData.height);
            if (profileData.weight) profileData.weight = parseFloat(profileData.weight);

            try {
                const response = await fetch('/api/update_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession}`
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸï¼');
                    await loadStats();
                    if (data.profile_complete) {
                        await loadDashboard();
                    }
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
            }
        });

        // ä¿å­˜åŒ¹é…åå¥½
        document.getElementById('preferencesForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const prefsData = Object.fromEntries(formData);

            // è½¬æ¢æ•°å€¼ç±»å‹
            if (prefsData.min_age) prefsData.min_age = parseInt(prefsData.min_age);
            if (prefsData.max_age) prefsData.max_age = parseInt(prefsData.max_age);
            if (prefsData.min_height) prefsData.min_height = parseInt(prefsData.min_height);
            if (prefsData.max_height) prefsData.max_height = parseInt(prefsData.max_height);

            try {
                const response = await fetch('/api/match_preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession}`
                    },
                    body: JSON.stringify(prefsData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… åŒ¹é…åå¥½ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // ç”Ÿæˆæ–°æ¨é€
        async function generatePushes() {
            try {
                const response = await fetch('/api/generate_pushes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    await loadStats();
                    await loadPushes();
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                alert('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        // å“åº”æ¨é€
        async function respondToPush(pushId, username, response) {
            try {
                console.log('å“åº”æ¨é€:', pushId, username, response);
                username = String(username);
                const user_y = localStorage.getItem(`${username}_y`);

                // fheåˆå§‹åŒ–
                const fhe = new FHE(currentUser);
                fhe.load_params();

                // è®¡ç®—å…±åŒå¯†é’¥
                const sharedKey = await fhe.compute_shared_secret(user_y);
                localStorage.setItem(`${currentUser}_${username}_shared_key`, sharedKey);

                // åŠ å¯†è”ç³»æ–¹å¼
                contact_info = localStorage.getItem(`contact_info_${currentUser}`);
                const encryptedContactInfo = await fhe.prepare_contact_info(contact_info);
                const encrypted_contact_info = encryptedContactInfo[0];
                const encrypted_key_c1 = encryptedContactInfo[1][0].toString();
                const encrypted_key_c2 = encryptedContactInfo[1][1].toString();

                // åŠ å¯†é€‰æ‹©
                if (response == 'accepted') {
                    encrypted_response = await fhe.encrypt_choice(true);
                } else {
                    encrypted_response = await fhe.encrypt_choice(false);
                }

                encrypted_response_c1 = encrypted_response[0].toString();
                encrypted_response_c2 = encrypted_response[1].toString();

                const apiResponse = await fetch('/api/respond_push', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession}`
                    },
                    body: JSON.stringify({
                        push_id: pushId,
                        encrypted_response_c1: encrypted_response_c1,
                        encrypted_response_c2: encrypted_response_c2,
                        encrypted_contact_info: encrypted_contact_info,
                        encrypted_key_c1: encrypted_key_c1,
                        encrypted_key_c2: encrypted_key_c2,
                    })
                });

                const data = await apiResponse.json();

                if (data.success) {
                    alert('âœ… å“åº”æˆåŠŸï¼');
                } else {
                    alert('âŒ å“åº”å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('å“åº”æ¨é€å¤±è´¥:', error);
                alert('âŒ å“åº”å¤±è´¥: ' + error.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            if (!confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) return;

            try {
                await secureElgamal.logout();
                alert('ç™»å‡ºæˆåŠŸï¼');
                window.location.href = '/';
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
                // å³ä½¿å¤±è´¥ä¹Ÿè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/';
            }
        }

        // åŠ è½½åŒ¹é…å†å²
        async function get_history() {
            let response;
            try {
                response = await fetch('/api/push_history', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }

                return data;
            } catch (error) {
                if (!response) {
                    console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
                    alert('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
                } else {
                    console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
                    alert('è·å–å†å²è®°å½•å¤±è´¥: ' + error.message);
                }
                throw error;
            }
        }

        // loadHistory
        async function loadHistory() {
            console.log('Call loadHistory()');
            const contentEl = document.getElementById('historiesContent'); // ä¿®æ”¹è¿™é‡Œï¼šä» matchesContent æ”¹ä¸º historiesContent
            contentEl.innerHTML = `
                <div class="loading">åŠ è½½ä¸­...</div>
            `;
        
            try {
                const historyData = await get_history();
        
                if (!historyData || historyData.length === 0) {
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <h3>ğŸ“œ åŒ¹é…å†å²</h3>
                            <p>æš‚æ— åŒ¹é…å†å²è®°å½•</p>
                        </div>
                    `;
                    return;
                }
        
                let historyHtml = '<h3>ğŸ“œ åŒ¹é…å†å²</h3>';
                historyHtml += '<div class="history-list">';
        
                historyData.forEach(item => {
                    const userInfo = item.user_info || {};
                    // const statusText = item.status === 'accepted' ? 'å·²å¤„ç†' : 'æœªå¤„ç†';
                    const statusClass = item.status === 'accepted' ? 'status-accepted' : 'status-pending';
        
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="history-user">
                                    <h4>${userInfo.nickname || userInfo.username || 'æœªçŸ¥ç”¨æˆ·'}</h4>
                                </div>
                                <div class="history-date">${formatDate(item.created_at)}</div>
                            </div>
                            
                            <div class="history-details">
                                <div class="user-basic-info">
                                    <span class="info-tag">ğŸ‘¤ ${getGenderText(userInfo.gender)}</span>
                                    ${userInfo.age ? `<span class="info-tag">ğŸ‚ ${userInfo.age}å²</span>` : ''}
                                    ${userInfo.height ? `<span class="info-tag">ğŸ“ ${userInfo.height}cm</span>` : ''}
                                    ${userInfo.education ? `<span class="info-tag">ğŸ“ ${getEducationText(userInfo.education)}</span>` : ''}
                                </div>
                                
                                ${userInfo.hobbies ? `
                                    <div class="user-hobbies">
                                        <strong>å…´è¶£çˆ±å¥½ï¼š</strong>${userInfo.hobbies}
                                    </div>
                                ` : ''}
                                
                                ${userInfo.bio ? `
                                    <div class="user-bio">
                                        <strong>ä¸ªäººç®€ä»‹ï¼š</strong>${userInfo.bio}
                                    </div>
                                ` : ''}
                                
                                <div class="history-actions">
                                    ${item.status === 'accepted' ? `
                                        <button class="btn btn-primary btn-small" onclick="handleFheMatchQueryFromHistory('${userInfo.username}')">
                                            ğŸ” æŸ¥çœ‹åŒ¹é…ç»“æœ
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
        
                historyHtml += '</div>';
                contentEl.innerHTML = historyHtml;
        
            } catch (error) {
                console.error('åŠ è½½åŒ¹é…å†å²å¤±è´¥:', error);
                contentEl.innerHTML = `
                    <div class="alert alert-error">
                        âŒ åŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // ä»å†å²è®°å½•ç›´æ¥æŸ¥è¯¢FHEåŒ¹é…ç»“æœ
        async function handleFheMatchQueryFromHistory(username) {
            // å…ˆè®¾ç½®ç”¨æˆ·ååˆ°è¾“å…¥æ¡†
            const usernameInput = document.getElementById('fheUsername');
            if (usernameInput) {
                usernameInput.value = username;
            }

            // åˆ‡æ¢åˆ°åŒ¹é…é¡µé¢
            showSection('matches');

            // ç­‰å¾…é¡µé¢åˆ‡æ¢å®Œæˆåæ‰§è¡ŒæŸ¥è¯¢
            setTimeout(() => {
                handleFheMatchQuery();
            }, 100);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';

            try {
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'æ—¥æœŸæ ¼å¼é”™è¯¯';
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getFieldName(field) {
            const fieldNames = {
                'nickname': 'æ˜µç§°',
                'age': 'å¹´é¾„',
                'gender': 'æ€§åˆ«',
                'bio': 'ä¸ªäººç®€ä»‹'
            };
            return fieldNames[field] || field;
        }

        function getGenderText(gender) {
            const genderMap = {
                'male': 'ç”·',
                'female': 'å¥³',
                'other': 'å…¶ä»–'
            };
            return genderMap[gender] || 'æœªçŸ¥';
        }

        function getEducationText(education) {
            const educationMap = {
                'bachelor': 'æœ¬ç§‘',
                'master': 'ç¡•å£«',
                'phd': 'åšå£«',
                'other': 'å…¶ä»–'
            };
            return educationMap[education] || 'æœªçŸ¥';
        }

        async function get_fhe_match_res(itsusername) {
            try {
                const response = await fetch('/api/fhe_match_results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession}`
                    },
                    body: JSON.stringify({
                        itsusername: itsusername
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('è·å–ç»“æœ:', data);
                    return data; // è¿”å›å®Œæ•´çš„å“åº”æ•°æ®
                } else {
                    console.error('è·å–ç»“æœå¤±è´¥:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('è·å–ç»“æœå¤±è´¥:', error);
                throw error; // æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
            }
        }

        // å¼ºåˆ¶é‡è½½æ•´ä¸ªé¡µé¢
        function forceReload() {
            window.location.reload(true);
        }
    </script>
</body>

</html>